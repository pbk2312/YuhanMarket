<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 페이지</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #007bff;
            color: #fff;
            border-bottom: none;
            font-size: 1.25rem;
            font-weight: 500;
        }
        .card-body {
            padding: 2rem;
        }
        .text-center {
            text-align: center;
        }
        .text-muted {
            color: #6c757d;
        }
        .pay-buttons {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }
        .pay-buttons button {
            width: 150px;
            margin: 0 0.5rem;
        }
        .pay-buttons .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .pay-buttons .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card mx-auto mt-5" style="max-width: 600px;">
        <div class="card-header text-center">결제 페이지</div>
        <div class="card-body">
            <h5 class="text-center mb-4">숙소 정보</h5>
            <p class="text-center mb-2" th:text="'숙소 이름: ' + ${paymentInfo.accommodationTitle}">숙소 이름: </p>
            <p class="text-center mb-2" th:text="'예약자명: ' + ${paymentInfo.name}">예약자명: </p>
            <p class="text-center mb-2" th:text="'총 결제금액: ' + ${paymentInfo.totalPrice} + ' 원'">총 결제금액: 0 원</p>
            <p class="text-center mb-2" th:text="'체크인 날짜: ' + ${paymentInfo.checkInDate}">체크인 날짜: </p>
            <p class="text-center mb-2" th:text="'체크아웃 날짜: ' + ${paymentInfo.checkOutDate}">체크아웃 날짜: </p>
            <p class="text-center mb-4" th:text="'특별 요청 사항: ' + ${paymentInfo.specialRequests}">특별 요청 사항: </p>

            <!-- 결제 버튼 -->
            <div class="pay-buttons">
                <button type="button" class="btn btn-primary" onclick="requestIamportPay()">결제하기</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery 라이브러리 -->
<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
<!-- Iamport 결제 모듈 -->
<script src="https://cdn.iamport.kr/js/iamport.payment-1.1.5.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Iamport 결제 요청 함수
    function requestIamportPay() {
        const IMP = window.IMP; // 생략가능
        IMP.init(''); // 'YOUR_IMP_PUBLIC_KEY'를 실제로 발급받은 PUBLIC KEY로 교체

        // 결제 요청 파라미터 설정
        IMP.request_pay({
            pg: 'html5_inicis', // PG사
            pay_method: 'card', // 결제수단
            merchant_uid: 'reservation_' + new Date().getTime(), // 주문번호
            name: document.querySelector('[th\\:text="\'숙소 이름: \' + ${paymentInfo.accommodationTitle}"').textContent.replace('숙소 이름: ', ''),
            amount: document.querySelector('[th\\:text="\'총 결제금액: \' + ${paymentInfo.totalPrice} + \' 원\'"]').textContent.replace('총 결제금액: ', '').replace(' 원', ''),
            buyer_name: document.querySelector('[th\\:text="\'예약자명: \' + ${paymentInfo.name}"').textContent.replace('예약자명: ', ''),
            buyer_tel: document.querySelector('[th\\:text="\'특별 요청 사항: \' + ${paymentInfo.specialRequests}"').textContent.replace('특별 요청 사항: ', ''),
            buyer_email: 'buyer@example.com' // 사용자의 이메일 주소
        }, function (rsp) {
            if (rsp.success) {
                // 결제 성공 시
                const result = {
                    "reservationId": rsp.merchant_uid, // 예약 번호
                    "payMethod": rsp.pay_method, // 결제수단
                    "totalPrice": rsp.paid_amount, // 결제금액
                    "paymentDate": new Date().toISOString().slice(0, 10) // 결제일
                };

                // 서버에 결제 성공 처리 요청
                fetch('/payment/success', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(result)
                })
                    .then(response => response.json())
                    .then(data => {
                        alert('결제가 완료되었습니다.');
                        window.location.href = data.redirectUrl; // 결제 후 리다이렉트 URL
                    })
                    .catch(error => {
                        console.error('결제 처리 중 오류 발생:', error);
                        alert('결제 처리 중 오류가 발생했습니다.');
                    });
            } else {
                // 결제 실패 시
                alert('결제에 실패했습니다. 에러 내용: ' + rsp.error_msg);
            }
        });
    }
</script>

</body>
</html>
